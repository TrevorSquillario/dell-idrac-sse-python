
x-default-logging: &logging
  driver: "json-file"
  options:
    max-size: "5m"
    max-file: "2"
    tag: "{{.Name}}"
    
services:
  idrac-sse:
    container_name: idrac-sse
    build:
      context: ./src/idrac-sse
    restart: unless-stopped
    environment:
      - LOGLEVEL=INFO
      - iDRAC_USERNAME=root
      - iDRAC_PASSWORD
      - OTEL_RECEIVER=http://${OTEL_COLLECTOR_HOST}:${OTEL_COLLECTOR_PORT_HTTP}
      - HTTP_RECEIVER
    volumes:
      #- ./hosts_test:/code/app/hosts
      - ./hosts:/code/app/hosts
    depends_on:
      activemq:
        condition: service_healthy
    networks:
      - idrac-sse-demo

  # Generate SSL Certificate: openssl req -x509 -newkey rsa:4096 -nodes -out cert.pem -keyout key.pem -days 365
  idrac-sse-testserver:
    container_name: idrac-sse-testserver
    build:
      context: ./src/test-server
    restart: unless-stopped
    ports:
      - 8443:443
    networks:
      - idrac-sse-demo

  otel-collector:
    image: ghcr.io/open-telemetry/opentelemetry-collector-releases/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    deploy:
      resources:
        limits:
          memory: 200M
    restart: unless-stopped
    command: [ "--config=/etc/otelcol-config.yml" ]
    user: 0:0
    volumes:
      - ${HOST_FILESYSTEM}:/hostfs:ro
      - ${DOCKER_SOCK}:/var/run/docker.sock:ro
      - ${OTEL_COLLECTOR_CONFIG}:/etc/otelcol-config.yml
    ports:
      - "${OTEL_COLLECTOR_PORT_GRPC}"
      - "${OTEL_COLLECTOR_PORT_HTTP}:${OTEL_COLLECTOR_PORT_HTTP}"
    logging: *logging
    environment:
      - ENVOY_PORT
      - HOST_FILESYSTEM
      - OTEL_COLLECTOR_HOST
      - OTEL_COLLECTOR_PORT_GRPC
      - OTEL_COLLECTOR_PORT_HTTP
    networks:
      - idrac-sse-demo

  activemq:
    container_name: activemq
    image: rmohr/activemq:latest
    environment:
      ACTIVEMQ_WEBADMIN_USERNAME: admin
      ACTIVEMQ_WEBADMIN_PASSWORD: admin
      ACTIVEMQ_USER: admin
      ACTIVEMQ_PASSWORD: admin
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "61616:61616"  # OpenWire port
      - "61613:61613"  # STOMP port
      - "8161:8161"    # WebConsole port
    healthcheck:
      test: ["CMD-SHELL", "curl -k -f http://localhost:8161"]
      interval: 5s
    networks:
      - idrac-sse-demo

networks:
  idrac-sse-demo:
    driver: bridge